-- ================================================================= --
-- SCRIPT DE CRIAÇÃO E POPULAÇÃO DE BANCO DE DADOS PARA MYSQL
-- ================================================================= --

-- Remove tabelas existentes para garantir um começo limpo
-- A ordem é importante para respeitar as chaves estrangeiras
DROP TABLE IF EXISTS user_games;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS game_genres;
DROP TABLE IF EXISTS game_platforms;
DROP TABLE IF EXISTS game_developers;
DROP TABLE IF EXISTS games;
DROP TABLE IF EXISTS genres;
DROP TABLE IF EXISTS platforms;
DROP TABLE IF EXISTS developers;

-- ================================================================= --
-- CRIAÇÃO DAS TABELAS COM TIMESTAMPS CORRIGIDOS PARA MYSQL
-- ================================================================= --

-- Tabelas de "Lookup" (Gêneros, Plataformas, Desenvolvedores)
CREATE TABLE genres (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(150) NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE platforms (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(150) NOT NULL UNIQUE,
    symbol_path VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE developers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(150) NOT NULL UNIQUE,
    location VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabela principal de Jogos
CREATE TABLE games (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(150) NOT NULL,
    release_date DATE,
    cover_path VARCHAR(255),
    banner_path VARCHAR(255),
    rating DECIMAL(3, 1),
    relevance INT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabelas de Junção para as relações Many-to-Many
CREATE TABLE game_genres (
    game_id BIGINT NOT NULL,
    genre_id BIGINT NOT NULL,
    PRIMARY KEY (game_id, genre_id),
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (genre_id) REFERENCES genres(id) ON DELETE CASCADE
);

CREATE TABLE game_platforms (
    game_id BIGINT NOT NULL,
    platform_id BIGINT NOT NULL,
    PRIMARY KEY (game_id, platform_id),
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (platform_id) REFERENCES platforms(id) ON DELETE CASCADE
);

CREATE TABLE game_developers (
    game_id BIGINT NOT NULL,
    developer_id BIGINT NOT NULL,
    PRIMARY KEY (game_id, developer_id),
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (developer_id) REFERENCES developers(id) ON DELETE CASCADE
);

-- Tabelas de Usuários e Biblioteca
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL -- Na prática, armazene um hash da senha!
);

CREATE TABLE user_games (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    game_id BIGINT NOT NULL,
    hours_played INT DEFAULT 0,
    status VARCHAR(50) NOT NULL,
    user_rating INT,
    acquisition_date DATE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE
);

-- ================================================================= --
-- INSERÇÃO DE DADOS DE EXEMPLO
-- ================================================================= --

-- Inserir Gêneros (não é mais necessário passar os timestamps)
INSERT INTO genres (id, name) VALUES
(1, 'Action'),
(2, 'RPG'),
(3, 'Adventure'),
(4, 'Strategy'),
(5, 'Puzzle'),
(6, 'Indie');

-- Inserir Plataformas
INSERT INTO platforms (id, name, symbol_path) VALUES
(1, 'PC', 'pc.png'),
(2, 'PlayStation 5', 'playstation.png'),
(3, 'Xbox Series X/S', 'xbox.png'),
(4, 'Nintendo Switch', 'nintendo_switch.png');

-- Inserir Desenvolvedores
INSERT INTO developers (id, name, location) VALUES
(1, 'CD Projekt Red', 'Warsaw, Poland'),
(2, 'FromSoftware', 'Tokyo, Japan'),
(3, 'Nintendo EPD', 'Kyoto, Japan'),
(4, 'Valve', 'Bellevue, USA');

-- Inserir Jogos
INSERT INTO games (id, name, release_date, rating) VALUES
(1, 'The Witcher 3: Wild Hunt', '2015-05-19', 9.8),
(2, 'Elden Ring', '2022-02-25', 9.7),
(3, 'Portal 2', '2011-04-19', 9.9),
(4, 'The Legend of Zelda: Tears of the Kingdom', '2023-05-12', 9.6);

-- Ligar Jogos aos Gêneros
INSERT INTO game_genres (game_id, genre_id) VALUES
(1, 1), (1, 2), (1, 3), -- Witcher 3: Action, RPG, Adventure
(2, 1), (2, 2),          -- Elden Ring: Action, RPG
(3, 5), (3, 3),          -- Portal 2: Puzzle, Adventure
(4, 1), (4, 3);          -- Zelda: Action, Adventure

-- Ligar Jogos às Plataformas
INSERT INTO game_platforms (game_id, platform_id) VALUES
(1, 1), (1, 2), (1, 3), (1, 4), -- Witcher 3
(2, 1), (2, 2), (2, 3),          -- Elden Ring
(3, 1),                         -- Portal 2
(4, 4);                         -- Zelda

-- Ligar Jogos aos Desenvolvedores
INSERT INTO game_developers (game_id, developer_id) VALUES
(1, 1),                         -- Witcher 3
(2, 2),                         -- Elden Ring
(3, 4),                         -- Portal 2
(4, 3);                         -- Zelda

-- Inserir Usuários
INSERT INTO users (id, username, password) VALUES
(1, 'brayan', 'senha123');

-- Inserir Jogos na Biblioteca do Usuário
INSERT INTO user_games (user_id, game_id, hours_played, status, user_rating, acquisition_date) VALUES
(1, 1, 120, 'COMPLETED', 10, '2018-07-15'),
(1, 2, 85, 'PLAYING', 10, '2022-03-01'),
(1, 4, 0, 'BACKLOG', NULL, '2023-05-12');

-- Fim do Script